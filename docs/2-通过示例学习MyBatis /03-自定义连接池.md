# 03. è‡ªå®šä¹‰è¿æ¥æ± 

æœ¬èŠ‚ç¤ºä¾‹ä»£ç åœ¨ [mybatis-demo-002](../../demo/mybatis-demo-002) ã€‚

## 1. mybatis å†…ç½®è¿æ¥æ± 
åœ¨ä¸Šä¸€èŠ‚ä¸­ MyBatis çš„é…ç½®æ–‡ä»¶`mybatis-config.xml`å¦‚ä¸‹ï¼š

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://127.0.0.1:3306/blog_db?useUnicode=true&amp;characterEncoding=utf8"/>
                <property name="username" value="root"/>
                <property name="password" value="123456"/>
            </dataSource>
        </environment>
    </environments>
    <mappers>
        <mapper resource="mapper/UserMapper.xml"/>
    </mappers>
</configuration>
```
å…¶ä¸­`<dataSource>`ç”¨æ¥é…ç½®æ•°æ®åº“è¿æ¥ï¼Œå®ƒæŒ‡å®šäº†typeä¸º`POOLED`ï¼Œæ„æ€æ˜¯å°†æ•°æ®åº“è¿æ¥æ”¾è¿›ã€Œæ± å­ã€é‡Œï¼Œä¹Ÿå°±æ˜¯**è¿æ¥æ± **ã€‚è‹¥typeè®¾ç½®æˆ`UNPOOLED`ï¼Œåˆ™ä¸ä½¿ç”¨è¿æ¥æ± ã€‚å„ç§æœåŠ¡ä¸­ä¸€èˆ¬å»ºè®®ä½¿ç”¨è¿æ¥æ± ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç®¡ç†è¿æ¥ï¼Œé€šè¿‡èµ„æºé‡ç”¨ä»¥èŠ‚çœå¼€é”€ã€‚

å¯¹äº mybatis çš„è¿æ¥æ± ï¼Œé™¤äº†é…ç½®æ•°æ®åº“åœ°å€ã€ç”¨æˆ·åã€å¯†ç ï¼Œè¿˜æœ‰æ›´å¤šå¯ä»¥é…ç½®ï¼Œä¾‹å¦‚é…ç½®æˆï¼š

```xml
<dataSource type="POOLED">
    <property name="driver" value="com.mysql.jdbc.Driver"/>
    <property name="url" value="jdbc:mysql://127.0.0.1:3306/blog_db?useUnicode=true&amp;characterEncoding=utf8"/>
    <property name="username" value="root"/>
    <property name="password" value="123456"/>

    <property name="poolMaximumActiveConnections" value="10" />
    <property name="poolTimeToWait" value="5000" />
    <property name="poolPingEnabled" value="true"/>
    <property name="poolPingQuery" value="select 1 from user" />
</dataSource>
```

è¿™äº›å±æ€§çš„ä»‹ç»ï¼Œå¯ä»¥åœ¨ http://www.mybatis.org/mybatis-3/zh/configuration.html æ‰¾åˆ°ã€‚


## 2. è‡ªå®šä¹‰è¿æ¥æ± 

`POOLED` ç”¨çš„æ˜¯mybatisè‡ªå·±å®ç°çš„è¿æ¥æ± ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰è¿æ¥æ± ã€‚

æ¯”å¦‚æˆ‘ä»¬ç”¨ DBCP è¿æ¥æ± ã€‚

**ç¬¬1æ­¥ï¼š**

é¦–å…ˆåœ¨ build.gradle ä¸­å¢åŠ ä¾èµ–ï¼š
```plain
compile group: 'org.apache.commons', name: 'commons-dbcp2', version: '2.5.0'
```

**ç¬¬2æ­¥ï¼š**

ç¼–å†™å®ç°`org.apache.ibatis.datasource.DataSourceFactory`æ¥å£çš„ç±»ï¼š
```java
package datasource;

import lombok.Data;
import org.apache.commons.dbcp2.BasicDataSource;
import org.apache.ibatis.datasource.DataSourceFactory;

import javax.sql.DataSource;
import java.util.Properties;

@Data
public class DBCPDataSourceFactory implements DataSourceFactory {

    private String username;
    private String password;
    private String driver;
    private String url;
    private int initialSize = 6;
    private int maxIdle = 8;
    private int minIdle = 6;

    @Override
    public void setProperties(Properties props) {
        username = props.getProperty("username");
        password = props.getProperty("password");
        driver = props.getProperty("driver");
        url = props.getProperty("url");

        initialSize = Integer.valueOf(props.getProperty("initialSize", ""+initialSize));
        maxIdle = Integer.valueOf(props.getProperty("maxIdle", ""+maxIdle));
        minIdle = Integer.valueOf(props.getProperty("minIdle", ""+minIdle));
    }

    @Override
    public DataSource getDataSource() {
        BasicDataSource dataSource = new BasicDataSource();
        dataSource.setUsername(username);
        dataSource.setPassword(password);
        dataSource.setUrl(url);
        dataSource.setDriverClassName(driver);
        dataSource.setInitialSize(initialSize);
        dataSource.setMaxIdle(maxIdle);
        dataSource.setMinIdle(minIdle);
        return dataSource;
    }

}
```
æˆ‘ä»¬å£°æ˜äº† usernameã€passwordã€driverã€urlã€initialSizeã€maxIdleã€minIdle 7ä¸ªå±æ€§ã€‚è¿™äº›å±æ€§å¯ä»¥åœ¨ mybatis é…ç½®æ–‡ä»¶ä¸­é…ç½®ã€‚è§ä¸‹ä¸€æ­¥ã€‚

**ç¬¬3æ­¥ï¼š**

åœ¨ resources ç›®å½•æ–°å¢ mybatis é…ç½®æ–‡ä»¶ `mybatis-config-dbcp.xml`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="datasource.DBCPDataSourceFactory">
                <property name="driver" value="com.mysql.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://127.0.0.1:3306/blog_db?useUnicode=true&amp;characterEncoding=utf8"/>
                <property name="username" value="root"/>
                <property name="password" value="123456"/>
                <property name="maxIdle" value="20"/>
            </dataSource>
        </environment>
    </environments>
    <mappers>
        <mapper resource="mapper/UserMapper.xml"/>
    </mappers>
</configuration>
```

æ³¨æ„ï¼Œ`<dataSource>` çš„ type å±æ€§å€¼æ˜¯ä¸Šé¢å®šä¹‰çš„ `DBCPDataSourceFactory` ç±»çš„å…¨è·¯å¾„ã€‚å‡ ä¸ª`<property>`æ ‡ç­¾ä¸­çš„ `name`å€¼ å’Œ `DBCPDataSourceFactory` ä¸­çš„å­—æ®µæ˜¯ä¸€è‡´çš„ã€‚

**ç¬¬4æ­¥ï¼š**

åœ¨ Main ç±»ä¸­ç¼–å†™ä¸šåŠ¡ä»£ç ï¼š
```java
@Test
public void test_02() throws IOException {
    SqlSessionFactoryBuilder sqlSessionFactoryBuilder = new SqlSessionFactoryBuilder();
    SqlSessionFactory sessionFactory;
    sessionFactory = sqlSessionFactoryBuilder.build(
            Resources.getResourceAsReader("mybatis-config-dbcp.xml"),
            "development"
    );
    SqlSession sqlSession = sessionFactory.openSession();

    try {
        UserMapper userMapper = sqlSession.getMapper(UserMapper.class);
        User user = userMapper.findById(1L);
        log.info("{}", user);
    } finally {
        sqlSession.close();
    }
}
```

æ‰§è¡Œç»“æœï¼š
```
 INFO [main] - User(id=1, name=letian, email=letian@111.com, password=123)
```

ç¬¦åˆé¢„æœŸï¼ğŸ˜†