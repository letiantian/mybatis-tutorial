# 15. åˆ†é¡µæŸ¥è¯¢



## ä»€ä¹ˆæ˜¯åˆ†é¡µï¼ˆpaginationï¼‰

ä¾‹å¦‚åœ¨æ•°æ®åº“çš„æŸä¸ªè¡¨é‡Œæœ‰1000æ¡æ•°æ®ï¼Œæˆ‘ä»¬æ¯æ¬¡åªæ˜¾ç¤º100æ¡æ•°æ®ï¼Œåœ¨ç¬¬1é¡µæ˜¾ç¤ºç¬¬0åˆ°ç¬¬99æ¡ï¼Œåœ¨ç¬¬2é¡µæ˜¾ç¤ºç¬¬100åˆ°199æ¡ï¼Œä¾æ¬¡ç±»æ¨ï¼Œè¿™å°±æ˜¯åˆ†é¡µã€‚

åˆ†é¡µå¯ä»¥åˆ†ä¸º`é€»è¾‘åˆ†é¡µ`å’Œ`ç‰©ç†åˆ†é¡µ`ã€‚

* `é€»è¾‘åˆ†é¡µ`æ˜¯æˆ‘ä»¬çš„ç¨‹åºåœ¨æ˜¾ç¤ºæ¯é¡µçš„æ•°æ®æ—¶ï¼Œé¦–å…ˆæŸ¥è¯¢å¾—åˆ°è¡¨ä¸­çš„1000æ¡æ•°æ®ï¼Œç„¶åæˆç†Ÿæ ¹æ®å½“å‰é¡µçš„â€œé¡µç â€é€‰å‡ºå…¶ä¸­çš„100æ¡æ•°æ®æ¥æ˜¾ç¤ºã€‚ä¸æ¨èä½¿ç”¨ã€‚
* `ç‰©ç†åˆ†é¡µ`æ˜¯ç¨‹åºå…ˆåˆ¤æ–­å‡ºè¯¥é€‰å‡ºè¿™1000æ¡çš„ç¬¬å‡ æ¡åˆ°ç¬¬å‡ æ¡ï¼Œç„¶åæ•°æ®åº“æ ¹æ®ç¨‹åºç»™å‡ºçš„ä¿¡æ¯æŸ¥è¯¢å‡ºç¨‹åºéœ€è¦çš„100æ¡è¿”å›ç»™æˆ‘ä»¬çš„ç¨‹åºã€‚



æˆ‘ä»¬ä»¥è§ [01. æ•°æ®å‡†å¤‡](01-æ•°æ®å‡†å¤‡.md) çš„blog è¡¨ä¸ºä¾‹å­¦ä¹ å¦‚ä½•ä½¿ç”¨mybatisè¿›è¡Œåˆ†é¡µæŸ¥è¯¢ã€‚

blog è¡¨æ•°æ®å¦‚ä¸‹ï¼š

```
mysql> select * from blog;
+----+----------+---------------+--------------+
| id | owner_id | title         | content      |
+----+----------+---------------+--------------+
|  1 |        1 | æ ‡é¢˜1         | æ–‡æœ¬1        |
|  2 |        1 | æ ‡é¢˜2         | æ–‡æœ¬2        |
|  3 |        1 | æ ‡é¢˜3         | æ–‡æœ¬3        |
|  4 |        1 | æ ‡é¢˜4         | æ–‡æœ¬4        |
|  5 |        1 | æ ‡é¢˜5         | æ–‡æœ¬5        |
|  6 |        2 | æ ‡é¢˜21        | æ–‡æœ¬21       |
|  7 |        1 | ä½ å¥½, World   | ä½ å¥½, ğŸ˜†       |
+----+----------+---------------+--------------+
```



æœ¬èŠ‚ç¤ºä¾‹ä»£ç åœ¨ [mybatis-demo-014](../../demo/mybatis-demo-014) ã€‚

é¡¹ç›®ç»“æ„ï¼š

<img src="../img/0006.jpg" width=300 />





log4j.properties ä¸­é…ç½®è®© mybatis è¾“å‡ºæ‰§è¡Œä¿¡æ¯ã€‚



## ç¤ºä¾‹1ï¼šåœ¨ sql ä¸­æ˜¾å¼ä½¿ç”¨ limit

åœ¨ BlogMapper æ¥å£ä¸­å¢åŠ æ–¹æ³•ï¼š

```java
List<Blog> findByUserId(Long ownerId, Integer limit, Integer offset);
```

è¯¥æ–¹æ³•ä½œç”¨æ˜¯æŸ¥è¯¢æŸä¸ªç”¨æˆ·æŒ‰ç…§idå‡åºæ’åºçš„æ‰€æœ‰æ–‡ç« ä¸­ï¼Œç¬¬limitç¯‡å¼€å§‹çš„å…±offsetç¯‡åšå®¢ã€‚æ³¨æ„ï¼Œ limit ä» 0 å¼€å§‹ã€‚

BlogMapper.xml ä¸­çš„SQL æ˜ å°„ï¼š

```xml
<select id="findByUserId" resultType="bean.Blog">
    SELECT
        id,
        owner_id AS ownerId,
        title,
        content
    FROM
        blog
    WHERE
        owner_id = #{param1}
    ORDER BY id ASC
    LIMIT  #{param2},  #{param3}
</select>
```

è¿™ä¸ªå±äºç‰©ç†æŸ¥è¯¢ã€‚

åœ¨ Main ç±»ä¸­ç¼–å†™ç¤ºä¾‹ä»£ç ï¼š

```java
@Test
public void test_01() throws IOException {
    SqlSession sqlSession = getSqlSession();
    BlogMapper blogMapper = sqlSession.getMapper(BlogMapper.class);
    List<Blog> blogList = blogMapper.findByUserId(1L, 0, 2);
    blogList.forEach(item -> {
        log.info("blog: {}", item);
    });
}

private SqlSession getSqlSession() throws IOException {
    SqlSessionFactory sessionFactory;
    sessionFactory = new SqlSessionFactoryBuilder()
            .build(Resources.getResourceAsReader("mybatis-config.xml"));
    return sessionFactory.openSession();
}
```

æ‰§è¡Œ test_01 å‡½æ•°ï¼Œç»“æœä¸ºï¼š

```plain
DEBUG [main] - Logging initialized using 'class org.apache.ibatis.logging.slf4j.Slf4jImpl' adapter.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - Opening JDBC Connection
DEBUG [main] - Created connection 1075738627.
DEBUG [main] - Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@401e7803]
DEBUG [main] - ==>  Preparing: SELECT id, owner_id AS ownerId, title, content FROM blog WHERE owner_id = ? ORDER BY id ASC LIMIT ?, ? 
DEBUG [main] - ==> Parameters: 1(Long), 0(Integer), 2(Integer)
DEBUG [main] - <==      Total: 2
 INFO [main] - blog: Blog(id=1, ownerId=1, title=æ ‡é¢˜1, content=æ–‡æœ¬1)
 INFO [main] - blog: Blog(id=2, ownerId=1, title=æ ‡é¢˜2, content=æ–‡æœ¬2)
```

ä¸­é—´å¯ä»¥çœ‹åˆ° mybatis çš„æ‰§è¡Œè¯­å¥å’Œå‚æ•°ã€‚æœ€åä¸¤è¡Œæ˜¯å¾—åˆ°çš„æŸ¥è¯¢ç»“æœã€‚



## ç¤ºä¾‹2ï¼šä½¿ç”¨ RowBounds è¿›è¡Œé€»è¾‘åˆ†é¡µæŸ¥è¯¢

mybatis è‡ªå¸¦ä¸€ä¸ª RowBounds ç±»å¯ä»¥å®ç°é€»è¾‘åˆ†é¡µã€‚

åœ¨ BlogMapper æ¥å£ä¸­å®šä¹‰æ–¹æ³•ï¼š

```java
List<Blog> findByUserIdWithRowBounds(Long ownerId, RowBounds rowBounds);
```

è¯¥æ–¹æ³•ä½œç”¨æ˜¯æŸ¥è¯¢æŸä¸ªç”¨æˆ·æŒ‰ç…§idå‡åºæ’åºçš„æ‰€æœ‰æ–‡ç« ä¸­ï¼Œç¬¬rowBounds.getLimit()ç¯‡å¼€å§‹çš„å…±rowBounds.getOffset()ç¯‡åšå®¢ã€‚æ³¨æ„ï¼Œ limit ä» 0 å¼€å§‹ã€‚mybatis ä¼šè‡ªåŠ¨è¯†åˆ«å‡º RowBounds å‚æ•°ã€‚

BlogMapper.xml ä¸­å¯¹åº”çš„ SQL ä¸å¿…å†™ limitï¼š

```xml
<select id="findByUserIdWithRowBounds" resultType="bean.Blog">
    SELECT
        id,
        owner_id AS ownerId,
        title,
        content
    FROM
        blog
    WHERE
        owner_id = #{param1}
    ORDER BY id ASC
</select>
```



åœ¨ Main ç±»ä¸­ç¼–å†™ç¤ºä¾‹ä»£ç ï¼š

```java
@Test
public void test_02() throws IOException {
    SqlSession sqlSession = getSqlSession();
    BlogMapper blogMapper = sqlSession.getMapper(BlogMapper.class);
    List<Blog> blogList = blogMapper.findByUserIdWithRowBounds(1L, new RowBounds(0, 2));
    blogList.forEach(item -> {
        log.info("blog: {}", item);
    });
}
```



æ‰§è¡Œç»“æœï¼š

```plain
DEBUG [main] - Logging initialized using 'class org.apache.ibatis.logging.slf4j.Slf4jImpl' adapter.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - Opening JDBC Connection
DEBUG [main] - Created connection 1075738627.
DEBUG [main] - Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@401e7803]
DEBUG [main] - ==>  Preparing: SELECT id, owner_id AS ownerId, title, content FROM blog WHERE owner_id = ? ORDER BY id ASC 
DEBUG [main] - ==> Parameters: 1(Long)
 INFO [main] - blog: Blog(id=1, ownerId=1, title=æ ‡é¢˜1, content=æ–‡æœ¬1)
 INFO [main] - blog: Blog(id=2, ownerId=1, title=æ ‡é¢˜2, content=æ–‡æœ¬2)
```



å¯ä»¥çœ‹åˆ°æ‰§è¡Œçš„ SQL å¹¶ä¸ºä½¿ç”¨ limit ï¼Œä½†è·å–çš„æ•°æ®åªæœ‰2æ¡ã€‚è¿™æ˜¯å› ä¸ºmybatisæŠŠæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®éƒ½å–å‡ºæ¥äº†ï¼Œç„¶åæ ¹æ® RowBounds å¯¹è±¡çš„å†…å®¹å–å‡ºéƒ¨åˆ†æ•°æ®è¿”å›ã€‚è¿™ç§`é€»è¾‘åˆ†é¡µ`å¾ˆæ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ï¼Œæ¯”å¦‚æœ‰10000000æ¡æ•°æ®æ»¡è¶³æ¡ä»¶ï¼Œè¿™ä¹ˆå¤§çš„æ•°æ®é‡å…¨éƒ¨ä»mysqlå–å‡ºæ¥è€—æ—¶å¾ˆé•¿ï¼Œä»mysqlä¼ åˆ°javaç¨‹åºè€—æ—¶å¾ˆé•¿ï¼Œjavaç¨‹åºçš„å†…å­˜å ç”¨ä¹Ÿä¼šå˜å¾ˆé«˜ï¼Œæ‰€ä»¥ä¸æ¨èè¿™ç§å®ç°ã€‚



ä½†è¿™ç§å†™æ³•å¾ˆæ–¹ä¾¿ï¼Œæˆ‘ä»¬æœ‰ä¿æŒè¿™ç§å†™æ³•ï¼Œè€Œåˆ†é¡µæŸ¥è¯¢æ˜¯ç‰©ç†åˆ†é¡µçš„æ–¹æ¡ˆå—ï¼Ÿæœ‰ï¼Œç”¨mybatisçš„æ‹¦æˆªå™¨ï¼ˆç†è§£ä¸ºæ’ä»¶ï¼Œå¯ä»¥è·å–è¦æ‰§è¡Œçš„sqlï¼Œä¿®æ”¹sqlï¼‰ã€‚å·²ç»æœ‰äººåšå‡ºè¿™æ ·çš„æ‹¦æˆªå™¨äº†ï¼Œæˆ‘ä»¬ç›´æ¥æ‹¿æ¥ç”¨ã€‚



### ç¤ºä¾‹3ï¼šä½¿ç”¨ RowBounds + PageHelper è¿›è¡Œç‰©ç†åˆ†é¡µæŸ¥è¯¢



PageHelperï¼ˆhttps://github.com/pagehelper/Mybatis-PageHelperï¼‰ æ˜¯ä¸€ä¸ªMybatisåˆ†é¡µæ’ä»¶ï¼Œç‰¹æ€§å¾ˆä¸°å¯Œã€‚



åœ¨ build.gradle ä¸­å¼•å…¥ä¾èµ–ï¼š

```
compile group: 'com.github.pagehelper', name: 'pagehelper', version: '5.1.7'
```

æ–°å»ºä¸€ä¸ª mybatis-config-with-pagehelper.xml ï¼Œå†…å®¹å’Œmybatis-config.xml åŸºæœ¬ä¸€æ ·ï¼Œä½†å¼•å…¥äº† pagehelper æ’ä»¶ï¼š

```xml
<configuration>

    <plugins>
        <plugin interceptor="com.github.pagehelper.PageInterceptor">
            <property name="rowBoundsWithCount" value="true"/>
        </plugin>
    </plugins>
    <!-- çœç•¥å±•ç¤ºå…¶ä»–é…ç½® -->
    <!-- ... -->
</configuration>
```



åœ¨ Main ç±»ä¸­ç¼–å†™ç¤ºä¾‹ä»£ç ï¼š

```java
@Test
public void test_03() throws IOException {
    SqlSession sqlSession = getSqlSessionWithPageHelperPluginInConfigXml();
    BlogMapper blogMapper = sqlSession.getMapper(BlogMapper.class);
    List<Blog> blogList = blogMapper.findByUserIdWithRowBounds(1L, new RowBounds(0, 2));
    blogList.forEach(item -> {
        log.info("blog: {}", item);
    });
}
private SqlSession getSqlSessionWithPageHelperPluginInConfigXml() throws IOException {
    SqlSessionFactory sessionFactory;
    sessionFactory = new SqlSessionFactoryBuilder()
            .build(Resources.getResourceAsReader("mybatis-config-with-pagehelper.xml"));
    return sessionFactory.openSession();
}
```

test_03 æ‰§è¡Œç»“æœï¼š

```plain
DEBUG [main] - Logging initialized using 'class org.apache.ibatis.logging.slf4j.Slf4jImpl' adapter.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - Created connection 323326911.
DEBUG [main] - Returned connection 323326911 to pool.
DEBUG [main] - Cache Hit Ratio [SQL_CACHE]: 0.0
DEBUG [main] - Opening JDBC Connection
DEBUG [main] - Checked out connection 323326911 from pool.
DEBUG [main] - Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@134593bf]
DEBUG [main] - ==>  Preparing: SELECT count(0) FROM blog WHERE owner_id = ? 
DEBUG [main] - ==> Parameters: 1(Long)
DEBUG [main] - <==      Total: 1
DEBUG [main] - ==>  Preparing: SELECT id, owner_id AS ownerId, title, content FROM blog WHERE owner_id = ? ORDER BY id ASC LIMIT ? 
DEBUG [main] - ==> Parameters: 1(Long), 2(Integer)
DEBUG [main] - <==      Total: 2
 INFO [main] - blog: Blog(id=1, ownerId=1, title=æ ‡é¢˜1, content=æ–‡æœ¬1)
 INFO [main] - blog: Blog(id=2, ownerId=1, title=æ ‡é¢˜2, content=æ–‡æœ¬2)
```

å¯ä»¥çœ‹åˆ°æ‰§è¡Œçš„SQLè¯­å¥ä¸­å‡ºç°äº† LIMIT ã€‚`LIMIT 0, 2` ä¸ `LIMIT 2`å«ä¹‰æ˜¯ä¸€æ ·çš„ã€‚



