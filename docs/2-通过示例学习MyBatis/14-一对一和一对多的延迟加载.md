# 14. ä¸€å¯¹ä¸€å’Œä¸€å¯¹å¤šçš„å»¶è¿ŸåŠ è½½

åœ¨[13. ä¸€å¯¹ä¸€å’Œä¸€å¯¹å¤šçš„å®ç°](13-ä¸€å¯¹ä¸€å’Œä¸€å¯¹å¤šçš„å®ç°.md) æˆ‘ä»¬äº†è§£äº† mybatis å¦‚ä½•å®ç°ä¸€å¯¹ä¸€å’Œä¸€å¯¹å¤šï¼Œå®ƒçš„å®ç°æ–¹æ¡ˆæ˜¯é€šè¿‡å†™ä¸€ä¸ªSQLå–å‡ºä¸¤å¼ è¡¨ç»“åˆåœ¨ä¸€èµ·çš„æ‰€æœ‰æ•°æ®ï¼Œç„¶åmybatisç¨ä½œå¤„ç†è¿›è¡Œè¿”å›ã€‚è¿˜æœ‰ä¸€ç§å®ç°æ–¹æ¡ˆæ˜¯ï¼Œå†™ä¸¤ä¸ªå•ç‹¬çš„ SQL ï¼Œé€šè¿‡idç­‰ä¸šåŠ¡å­—æ®µè¿›è¡Œå…³è”ï¼Œç„¶ååˆ†åˆ«æ‰§è¡Œï¼Œå¾—åˆ°æœ€ç»ˆç»“æœã€‚è¿™ç§æ–¹æ¡ˆï¼Œè¿˜æœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼Œå°±æ˜¯æ”¯æŒå»¶è¿ŸåŠ è½½ã€‚



æœ¬èŠ‚ç¤ºä¾‹ä»£ç åœ¨ [mybatis-demo-013](../../demo/mybatis-demo-013) ï¼ŒåŸºäº[13. ä¸€å¯¹ä¸€å’Œä¸€å¯¹å¤šçš„å®ç°](13-ä¸€å¯¹ä¸€å’Œä¸€å¯¹å¤šçš„å®ç°.md) ä¸­çš„ç¤ºä¾‹  [mybatis-demo-013](../../demo/mybatis-demo-013) ã€‚



## æ•°æ®å‡†å¤‡

è§ [01. æ•°æ®å‡†å¤‡](01-æ•°æ®å‡†å¤‡.md)ã€‚

userè¡¨å’Œblogè¡¨çš„é»˜è®¤å†…å®¹å¦‚ä¸‹ï¼š

```plain
mysql> select * from user;
+----+--------+----------------+----------+
| id | name   | email          | password |
+----+--------+----------------+----------+
|  1 | letian | letian@111.com | 123      |
|  2 | xiaosi | xiaosi@111.com | 123      |
+----+--------+----------------+----------+

mysql> select * from blog;
+----+----------+---------------+--------------+
| id | owner_id | title         | content      |
+----+----------+---------------+--------------+
|  1 |        1 | æ ‡é¢˜1         | æ–‡æœ¬1        |
|  2 |        1 | æ ‡é¢˜2         | æ–‡æœ¬2        |
|  3 |        1 | æ ‡é¢˜3         | æ–‡æœ¬3        |
|  4 |        1 | æ ‡é¢˜4         | æ–‡æœ¬4        |
|  5 |        1 | æ ‡é¢˜5         | æ–‡æœ¬5        |
|  6 |        2 | æ ‡é¢˜21        | æ–‡æœ¬21       |
|  7 |        1 | ä½ å¥½, World   | ä½ å¥½, ğŸ˜†       |
+----+----------+---------------+--------------+
```


## é¡¹ç›®ç»“æ„

ä½¿ç”¨ IDEA åˆ›å»º gradle é¡¹ç›®ï¼Œæœ€ç»ˆç»“æ„å¦‚ä¸‹ï¼š

<img src="../img/0004.jpg" width=300 />





## æ ¹æ®idæŸ¥è¯¢åšå®¢åŠå…¶æ‰€å±ç”¨æˆ·ä¿¡æ¯



åœ¨ BlogMapper æ¥å£ä¸­æ–°å¢æ–¹æ³•ï¼š

```java
Blog findById(Long id);
```

åœ¨ BlogMapper.xml ä¸­å¢åŠ æ˜ å°„ï¼š

```xml
<resultMap id="blogResult" type="bean.Blog">
    <result property="id" column="blog_id"/>
    <result property="ownerId" column="user_id"/>
    <result property="title" column="blog_title"/>
    <result property="content" column="blog_content"/>

    <association property="user"
                 javaType="bean.User"
                 select="findOwnerOfBlog"
                 column="user_id" />

</resultMap>

<resultMap id="userResult" type="bean.User">
    <result property="id" column="user_id"/>
    <result property="name" column="user_name"/>
    <result property="email" column="user_email"/>
    <result property="password" column="user_password"/>
</resultMap>

<select id="findById" parameterType="Long" resultMap="blogResult" resultType="bean.Blog">
    SELECT
        id AS blog_id,
        id AS user_id,
        title AS blog_title,
        content AS blog_content
    FROM
        blog
    WHERE
        id = #{id};
</select>

<select id="findOwnerOfBlog"  parameterType="int"  resultMap="userResult" resultType="bean.User">
    SELECT
        id user_id,
        name user_name,
        email user_email,
        password user_password
    FROM
        user
    WHERE
        id=#{user_id};
</select>
```

`findById` æ–¹æ³•æ˜¯å’Œ `<select id="findById"></select>`å¯¹åº”çš„ã€‚ `<select id="findById"></select>` çš„SQL åªæ˜¯ä» blogè¡¨ä¸­è¯»å–æ•°æ®ï¼Œå®ƒçš„`resultMap`å±æ€§å€¼æ˜¯`blogResult`ï¼Œå¯¹åº”`<resultMap id="blogResult"></resultMap>`ã€‚è€Œ` <resultMap id="blogResult"></resultMap>`ä¸­çš„`<association>`ä½¿ç”¨äº†`select`å’Œ`column`å±æ€§ï¼š

```xml
<association property="user"
                javaType="bean.User"
                select="findOwnerOfBlog"
                column="user_id" />
```

`selecct`å¯¹åº”çš„å€¼æ˜¯`findOwnerOfBlog`ï¼Œæ„æ€æ˜¯æ‰¾`<select id="findOwnerOfBlog"><select>`ï¼Œ`column`çš„å€¼æ˜¯`user_id`ï¼Œæ„æ€æ˜¯å°†`user_id` çš„å€¼ä¼ åˆ°`<select id="findOwnerOfBlog"><select>`ä¸­ã€‚



åœ¨ Main ç±»ä¸­ç¼–å†™ç¤ºä¾‹ä»£ç ï¼š

```java
@Test
public void test_03() throws IOException {
    SqlSession sqlSession = getSqlSession();
    BlogMapper blogMapper = sqlSession.getMapper(BlogMapper.class);
    Blog blog = blogMapper.findById(1L);
    log.info("id:{}, title:{}, content:{}", blog.getId(), blog.getTitle(), blog.getContent());
    log.info("user: {}", blog.getUser());
}
```



æ‰§è¡Œç»“æœï¼š

```plain
DEBUG [main] - Logging initialized using 'class org.apache.ibatis.logging.slf4j.Slf4jImpl' adapter.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - Opening JDBC Connection
DEBUG [main] - Created connection 278934944.
DEBUG [main] - Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@10a035a0]
DEBUG [main] - ==>  Preparing: SELECT id AS blog_id, id AS user_id, title AS blog_title, content AS blog_content FROM blog WHERE id = ?; 
DEBUG [main] - ==> Parameters: 1(Long)
DEBUG [main] - ====>  Preparing: SELECT id user_id, name user_name, email user_email, password user_password FROM user WHERE id=?; 
DEBUG [main] - ====> Parameters: 1(Integer)
DEBUG [main] - <====      Total: 1
DEBUG [main] - <==      Total: 1
 INFO [main] - id:1, title:æ ‡é¢˜1, content:æ–‡æœ¬1
 INFO [main] - user: User(id=1, name=letian, email=letian@111.com, password=123, blogs=null)
```



å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªSQLä¾æ¬¡æ‰§è¡Œã€‚



## å¦‚ä½•è®¾ç½®å»¶è¿ŸåŠ è½½

ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œåœ¨æˆ‘ä»¬æœªè·å– user ä¿¡æ¯æ—¶ï¼Œå°±å·²ç»æŠŠuserä¿¡æ¯å–å‡ºæ¥äº†ã€‚å¦‚ä½•åšåˆ°ï¼Œç”¨åˆ°å†åŠ è½½ï¼Œä¹Ÿå°±æ˜¯å»¶è¿ŸåŠ è½½å‘¢ï¼Ÿ

å¾ˆç®€å•ï¼Œåœ¨ `mybatis-config.xml` åŠ å…¥ï¼š

```xml
<settings>
    <setting name="lazyLoadingEnabled" value="true"/>
    <setting name="aggressiveLazyLoading" value="false"/>
</settings>
```

å†æ¬¡æ‰§è¡Œä¸Šé¢çš„ç¤ºä¾‹ä»£ç ï¼Œç»“æœæ˜¯ï¼š

```plain
DEBUG [main] - Logging initialized using 'class org.apache.ibatis.logging.slf4j.Slf4jImpl' adapter.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - PooledDataSource forcefully closed/removed all connections.
DEBUG [main] - Opening JDBC Connection
DEBUG [main] - Created connection 1209669119.
DEBUG [main] - Setting autocommit to false on JDBC Connection [com.mysql.jdbc.JDBC4Connection@481a15ff]
DEBUG [main] - ==>  Preparing: SELECT id AS blog_id, id AS user_id, title AS blog_title, content AS blog_content FROM blog WHERE id = ?; 
DEBUG [main] - ==> Parameters: 1(Long)
DEBUG [main] - <==      Total: 1
 INFO [main] - id:1, title:æ ‡é¢˜1, content:æ–‡æœ¬1
DEBUG [main] - ==>  Preparing: SELECT id user_id, name user_name, email user_email, password user_password FROM user WHERE id=?; 
DEBUG [main] - ==> Parameters: 1(Integer)
DEBUG [main] - <==      Total: 1
 INFO [main] - user: User(id=1, name=letian, email=letian@111.com, password=123, blogs=null)
```

æ³¨æ„ï¼Œ` INFO [main] - id:1, title:æ ‡é¢˜1, content:æ–‡æœ¬1`å’Œ` INFO [main] - user: User(id=1, name=letian, email=letian@111.com, password=123, blogs=null)`ä¹‹é—´ï¼Œmybatisè¾“å‡ºäº†æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯çš„æ—¥å¿—ï¼Œè¿™å°±æ˜¯å»¶è¿ŸåŠ è½½ã€‚