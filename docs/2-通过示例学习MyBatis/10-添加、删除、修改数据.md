# 10. æ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹æ•°æ®

æœ¬èŠ‚ç¤ºä¾‹ä»£ç åœ¨ [mybatis-demo-009](../../demo/mybatis-demo-009) ã€‚



## æ•°æ®å‡†å¤‡

è§ [01. æ•°æ®å‡†å¤‡](01-æ•°æ®å‡†å¤‡.md)ã€‚

## é¡¹ç›®ç»“æ„

ä½¿ç”¨ IDEA åˆ›å»º gradle é¡¹ç›®ï¼Œæœ€ç»ˆç»“æ„å¦‚ä¸‹ï¼š

<img src="../img/0001.jpg" width=300 />

## æ·»åŠ æ•°æ®



åœ¨ UserMapper æ¥å£ä¸­å®šä¹‰æ–¹æ³•ï¼š

```java
/**
 * æ ¹æ® id æŸ¥è¯¢ç”¨æˆ·
 */
User findById(Long id);
```



åœ¨ UserMapper.xml ä¸­ç¼–å†™æ˜ å°„ï¼š

```xml
<!--insertUser-->
<insert id="insertUser" parameterType="bean.User" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO blog_db.user (name, email, password)
    VALUES (#{name}, #{email}, #{password})
</insert>
```

`<insert>` ä¸­idä¸º`insertUser`ï¼Œå’Œæ–¹æ³•å¯¹åº”UserMapperæ¥å£ä¸­æ–¹æ³•ä¸€è‡´ã€‚`parameterType`å’Œæ–¹æ³•`insertUser`çš„å‚æ•°ç±»å‹ä¸€è‡´ã€‚

æˆ‘ä»¬çš„SQLè¯­å¥ï¼Œåªæ’å…¥äº†Userçš„nameã€emailã€passwordï¼Œä¸»é”®idä¾é æ•°æ®åº“çš„è‡ªåŠ¨ç”Ÿæˆã€‚åœ¨å®˜æ–¹æ–‡æ¡£[ã€ŠMapper XML æ–‡ä»¶ã€‹](http://mybatis.github.io/mybatis-3/zh/sqlmap-xml.html)ä¸­å¦‚ä¸‹ä»‹ç»useGeneratedKeyså’ŒkeyPropertyå±æ€§ï¼š

> useGeneratedKeysï¼šï¼ˆä»…å¯¹ insert å’Œ update æœ‰ç”¨ï¼‰è¿™ä¼šä»¤ MyBatis ä½¿ç”¨ JDBC çš„ getGeneratedKeys æ–¹æ³•æ¥å–å‡ºç”±æ•°æ®åº“å†…éƒ¨ç”Ÿæˆçš„ä¸»é”®ï¼ˆæ¯”å¦‚ï¼šåƒ MySQL å’Œ SQL Server è¿™æ ·çš„å…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿçš„è‡ªåŠ¨é€’å¢å­—æ®µï¼‰ï¼Œé»˜è®¤å€¼ï¼šfalseã€‚

> keyPropertyï¼š ï¼ˆä»…å¯¹ insert å’Œ update æœ‰ç”¨ï¼‰å”¯ä¸€æ ‡è®°ä¸€ä¸ªå±æ€§ï¼ŒMyBatis ä¼šé€šè¿‡ getGeneratedKeys çš„è¿”å›å€¼æˆ–è€…é€šè¿‡ insert è¯­å¥çš„ selectKey å­å…ƒç´ è®¾ç½®å®ƒçš„é”®å€¼ï¼Œé»˜è®¤ï¼šunsetã€‚å¦‚æœå¸Œæœ›å¾—åˆ°å¤šä¸ªç”Ÿæˆçš„åˆ—ï¼Œä¹Ÿå¯ä»¥æ˜¯é€—å·åˆ†éš”çš„å±æ€§åç§°åˆ—è¡¨ã€‚

**ä¸å¤ªæ˜ç™½ä¸ºä»€ä¹ˆä¼šå¯¹updateæœ‰ç”¨ã€‚å…ˆä¸ç®¡ã€‚**

é€šè¿‡è®¾ç½®useGeneratedKeyså’ŒkeyPropertyå±æ€§ï¼Œå¯ä»¥å°†ç”Ÿæˆçš„idæ³¨å…¥åˆ°userå¯¹è±¡çš„idå­—æ®µä¸­ã€‚

åœ¨Mainç±»ä¸­ç¼–å†™ç¤ºä¾‹ä»£ç ï¼š

```java
import java.io.IOException;

import lombok.extern.slf4j.Slf4j;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import bean.User;
import mapper.UserMapper;
import org.junit.Test;


@Slf4j
public class Main {

    @Test
    public void test_insertUser() throws IOException {
        SqlSession sqlSession = getSqlSession(false);
        UserMapper userMapper = sqlSession.getMapper(UserMapper.class);
        User user = new User();
        user.setName("xiaowei");
        user.setEmail("xiaowei@111.com");
        user.setPassword("456");

        try {
            int result = userMapper.insertUser(user);
            log.info("result: {}, user: {}", result, user);
            sqlSession.commit();
        } finally {
            sqlSession.close();
        }
    }

    private SqlSession getSqlSession(boolean autoCommit) throws IOException {
        SqlSessionFactory sessionFactory;
        sessionFactory = new SqlSessionFactoryBuilder()
                .build(Resources.getResourceAsReader("mybatis-config.xml"));
        return sessionFactory.openSession(autoCommit);
    }

}
```

åˆ›å»ºsqlSessionæ—¶ï¼Œæˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªå¸ƒå°”å‚æ•° autoCommitã€‚å¦‚å­—é¢æ„æ€ï¼Œå¦‚ä¸ºtrueï¼Œåˆ™å¼€å¯è‡ªåŠ¨commitï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªinsertã€updateã€deleteæ“ä½œéƒ½ä¼šç¡®ç¡®å®å®çš„å°†æ•°æ®ä¿®æ”¹å†™å…¥æ•°æ®åº“ä¸­ã€‚è€Œå¦‚æœæ˜¯falseï¼Œåˆ™å¿…é¡»åœ¨ä¸€ç³»åˆ—æ“ä½œåï¼ŒåŠ ä¸Š`sqlSession.commit()`ï¼Œæ‰èƒ½å°†æ•°æ®ä¿®æ”¹çœŸæ­£å†™å…¥æ•°æ®åº“ã€‚



è¿è¡Œ test_insertUser å‡½æ•°ï¼Œç»“æœï¼š

```
 INFO [main] - result: 1, user: User(id=3, name=xiaowei, email=xiaowei@111.com, password=456)
```

æ–°æ·»åŠ çš„è®°å½•idä¸º3ã€‚

æŸ¥çœ‹æ•°æ®åº“ï¼š

```
mysql> select * from user;
+----+---------+-----------------+----------+
| id | name    | email           | password |
+----+---------+-----------------+----------+
|  1 | letian  | letian@111.com  | 123      |
|  2 | xiaosi  | xiaosi@111.com  | 123      |
|  3 | xiaowei | xiaowei@111.com | 456      |
+----+---------+-----------------+----------+
3 rows in set (0.00 sec)
```



## æ ¹æ® id æ›´æ–°å¯†ç 

åœ¨ UserMapper æ¥å£ä¸­å®šä¹‰æ–¹æ³•ï¼š

```java
/**
 * æ ¹æ® id æ›´æ–°å¯†ç 
 * @return å½±å“çš„è¡Œæ•°
 */
int updateUserPasswordById(User user);
```



åœ¨ UserMapper.xml å¢åŠ æ˜ å°„ï¼š

```xml
<update id="updateUserPasswordById" parameterType="bean.User">
    UPDATE blog_db.user
    SET password=#{password}
    WHERE id=#{id}
</update>
```

updateUserPasswordById æ–¹æ³•çš„å‚æ•°æ˜¯Userç±»ï¼Œåœ¨xmlæ˜ å°„ä¸­Userçš„å˜é‡ä¼šè¢«è§£æå‡ºæ¥ï¼Œæ‰€ä»¥å¯ä»¥ç”¨å ä½ç¬¦`#{password}`ã€`#{id}`ã€‚



åœ¨Mainç±»ä¸­ç¼–å†™ç¤ºä¾‹ä»£ç ï¼š

```java
@Test
public void test_updateUserPasswordById() throws IOException {
    SqlSession sqlSession = getSqlSession(false);
    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);
    User user = new User();
    user.setId(3L);
    user.setPassword("123456");

    try {
        int result = userMapper.updateUserPasswordById(user);
        log.info("result: {}, user: {}", result, user);
        sqlSession.commit();
    } finally {
        sqlSession.close();
    }
}
```

è¿è¡Œç»“æœï¼š

```plain
 INFO [main] - result: 1, user: User(id=3, name=null, email=null, password=123456)
```

æŸ¥çœ‹æ•°æ®åº“ï¼š

```plain
mysql> select * from user;
+----+---------+-----------------+----------+
| id | name    | email           | password |
+----+---------+-----------------+----------+
|  1 | letian  | letian@111.com  | 123      |
|  2 | xiaosi  | xiaosi@111.com  | 123      |
|  3 | xiaowei | xiaowei@111.com | 123456   |
+----+---------+-----------------+----------+
3 rows in set (0.00 sec)
```

å¯ä»¥çœ‹åˆ° idä¸º3çš„è®°å½•çš„å¯†ç ä»456å˜æˆäº†123456ã€‚



## åˆ é™¤æŒ‡å®š id çš„è®°å½•

åœ¨ UserMapper æ¥å£ä¸­å®šä¹‰æ–¹æ³•ï¼š

```java
/**
 * åˆ é™¤æŒ‡å®šidçš„è®°å½•
 * @return å½±å“çš„è¡Œæ•°
 */
int deleteById(Long id);
```



åœ¨ UserMapper.xml å¢åŠ æ˜ å°„ï¼š

```xml
<delete id="deleteById" parameterType="Long">
    DELETE FROM blog_db.user WHERE id=#{id}
</delete>
```



åœ¨Mainç±»ä¸­ç¼–å†™ç¤ºä¾‹ä»£ç ï¼Œåˆ é™¤idä¸º3çš„è®°å½•ï¼š

```java
@Test
public void test_deleteById() throws IOException {
    SqlSession sqlSession = getSqlSession(false);
    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);

    try {
        int result = userMapper.deleteById(3L);
        log.info("result: {}", result);
        sqlSession.commit();
    } finally {
        sqlSession.close();
    }
}
```

è¿è¡Œç»“æœï¼š

```plain
 INFO [main] - result: 1
```

å› ä¸ºidä¸º3çš„è®°å½•å·²ç»è¢«åˆ é™¤äº†ï¼Œæ‰€ä»¥è‹¥å†è¿è¡Œä¸€æ¬¡ï¼Œç»“æœä¸ºï¼š

```plain
 INFO [main] - result: 0
```

æŸ¥çœ‹æ•°æ®åº“ï¼š

```plain
mysql> select * from user;
+----+--------+----------------+----------+
| id | name   | email          | password |
+----+--------+----------------+----------+
|  1 | letian | letian@111.com | 123      |
|  2 | xiaosi | xiaosi@111.com | 123      |
+----+--------+----------------+----------+
2 rows in set (0.00 sec)
```



## åˆ é™¤æŒ‡å®š id èŒƒå›´çš„è®°å½•

åœ¨ UserMapper æ¥å£ä¸­å®šä¹‰æ–¹æ³•ï¼š

```java
/**
 * åˆ é™¤idåœ¨ [minId, maxId] èŒƒå›´å†…çš„è®°å½•
 * @return å½±å“çš„è¡Œæ•°
 */
int deleteByIdRange(Long minId, Long maxId);
```



åœ¨ UserMapper.xml å¢åŠ æ˜ å°„ï¼š

```xml
<delete id="deleteByIdRange">
    <![CDATA[
        DELETE FROM blog_db.user WHERE id >= #{param1} and id <= #{param2}
    ]]>
</delete>
```

åœ¨Mainç±»ä¸­ç¼–å†™ç¤ºä¾‹ä»£ç ï¼Œåˆ é™¤idä¸º1åˆ°2çš„è®°å½•ï¼š

```java
@Test
public void test_deleteByIdRange() throws IOException {
    SqlSession sqlSession = getSqlSession(false);
    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);

    try {
        int result = userMapper.deleteByIdRange(1L, 2L);
        log.info("result: {}", result);
        sqlSession.commit();
    } finally {
        sqlSession.close();
    }
}
```



è¿è¡Œç»“æœï¼š

```plain
 INFO [main] - result: 2
```



æŸ¥çœ‹æ•°æ®åº“ï¼š

```plain
mysql> select * from user;
Empty set (0.00 sec)
```

æ²¡æœ‰æ•°æ®äº†ï¼Œç¬¦åˆé¢„æœŸ ğŸ˜†

