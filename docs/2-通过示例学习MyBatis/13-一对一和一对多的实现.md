æœ¬èŠ‚ç¤ºä¾‹ä»£ç åœ¨ [mybatis-demo-012](../../demo/mybatis-demo-012) ã€‚



## æ•°æ®å‡†å¤‡

è§ [01. æ•°æ®å‡†å¤‡](01-æ•°æ®å‡†å¤‡.md)ã€‚

userè¡¨å’Œblogè¡¨çš„é»˜è®¤å†…å®¹å¦‚ä¸‹ï¼š

```plain
mysql> select * from user;
+----+--------+----------------+----------+
| id | name   | email          | password |
+----+--------+----------------+----------+
|  1 | letian | letian@111.com | 123      |
|  2 | xiaosi | xiaosi@111.com | 123      |
+----+--------+----------------+----------+

mysql> select * from blog;
+----+----------+---------------+--------------+
| id | owner_id | title         | content      |
+----+----------+---------------+--------------+
|  1 |        1 | æ ‡é¢˜1         | æ–‡æœ¬1        |
|  2 |        1 | æ ‡é¢˜2         | æ–‡æœ¬2        |
|  3 |        1 | æ ‡é¢˜3         | æ–‡æœ¬3        |
|  4 |        1 | æ ‡é¢˜4         | æ–‡æœ¬4        |
|  5 |        1 | æ ‡é¢˜5         | æ–‡æœ¬5        |
|  6 |        2 | æ ‡é¢˜21        | æ–‡æœ¬21       |
|  7 |        1 | ä½ å¥½, World   | ä½ å¥½, ğŸ˜†       |
+----+----------+---------------+--------------+
```


## é¡¹ç›®ç»“æ„

ä½¿ç”¨ IDEA åˆ›å»º gradle é¡¹ç›®ï¼Œæœ€ç»ˆç»“æ„å¦‚ä¸‹ï¼š

<img src="../img/0004.jpg" width=300 />

## æ–°çš„ Userã€Blog ç±»



åœ¨ User ç±»ä¸­æ–°å¢å­—æ®µ

```java
package bean;

import lombok.Data;

import java.util.List;

@Data
public class User {

    private Long id;
    private String name;
    private String email;
    private String password;
    private List<Blog> blogs; // å±äºè¯¥ç”¨æˆ·çš„åšå®¢

}

```

ç”¨æˆ·å’Œåšå®¢æ˜¯ä¸€å¯¹å¤šçš„å…³å¿ƒï¼Œæ‰€ä»¥å¢åŠ äº†`List<Blog> blogs`å˜é‡ã€‚



åœ¨æœ¬èŠ‚ç¤ºä¾‹ä¸­ä¼šæ–°å¼•å…¥æœ‰å¼•å…¥blog è¡¨ï¼Œå¯¹åº”çš„ bean å®šä¹‰ï¼š

```java
package bean;

import lombok.Data;

@Data
public class Blog {

    private Long id;
    private Long ownerId;  // åšå®¢ä½œè€…çš„ç”¨æˆ·id
    private String title;
    private String content;
    private User user;  // åšå®¢ä½œè€…ä¿¡æ¯
    
}
```

åšå®¢å’Œç”¨æˆ·æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œæ‰€ä»¥å¢åŠ äº†`User user`å˜é‡ã€‚

## è®©mybatisè¾“å‡ºæ‰§è¡Œæµç¨‹

é…ç½® log4j.properties å†…å®¹ä¸ºï¼š
```ini
log4j.rootLogger=DEBUG, stdout
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%5p [%t] - %m%n

# mapper åŒ…ä¸‹çš„æ‰€æœ‰æ¥å£çš„æ–¹æ³•éƒ½ä¼šæ‰“æ—¥å¿—ï¼Œä¼šæ‰“å°ä¸ä½äº DEBUG çº§åˆ«çš„æ—¥å¿—
log4j.logger.org.mybatis.mapper=TRACE
```

å¦‚æ­¤ï¼Œmapper åŒ…ä¸‹çš„æ‰€æœ‰æ¥å£çš„æ–¹æ³•éƒ½ä¼šæ‰“æ—¥å¿—ï¼Œä¼šæ‰“å°ä¸ä½äº DEBUG çº§åˆ«çš„æ—¥å¿—ã€‚è€ŒDEBUG æ˜¯æ—¥å¿—çš„æœ€ä½çº§åˆ«ï¼Œæ‰€ä»¥è¿™ç§é…ç½®æˆ‘ä»¬èƒ½çœ‹åˆ°mybatisçš„è¿è¡Œæµç¨‹ã€‚



## æ ¹æ® id è·å–ç”¨æˆ·åŠå…¶åšå®¢ä¿¡æ¯

åœ¨ UserMapper ä¸­å¢åŠ æ–¹æ³•ï¼š
```java
User findById(Long id);
```

åœ¨ UserMapper.xml å¢åŠ ä»¥ä¸‹å†…å®¹ï¼š
```xml
<resultMap id="userResult" type="bean.User">

    <result property="id" column="user_id"/>
    <result property="name" column="user_name"/>
    <result property="email" column="user_email"/>
    <result property="password" column="user_password"/>

    <collection property="blogs" ofType="bean.Blog">
        <id property="id" column="blog_id"/>
        <result property="ownerId" column="user_id"/>
        <result property="title" column="blog_title"/>
        <result property="content" column="blog_content"/>
    </collection>

</resultMap>

<select id="findById" parameterType="Long" resultMap="userResult" resultType="bean.User">
    SELECT
        user.id AS user_id,
        user.name AS user_name,
        user.email AS user_email,
        user.password AS user_password,
        blog.id AS blog_id,
        blog.title AS blog_title,
        blog.content AS blog_content
    FROM user, blog 
    WHERE 
        user.id = #{id} 
        AND user.id=blog.owner_id;
</select>
```

`<select id="findById"></select>`ä¸­çš„sqlè¯­å¥çš„ä½œç”¨æ˜¯æ ¹æ®ç»™å‡ºçš„ç”¨æˆ·idå¾—åˆ°ç”¨æˆ·çš„ä¿¡æ¯ä»¥åŠè¯¥ç”¨æˆ·æ‰€æœ‰çš„blogï¼Œæ‰€ä»¥SQL æ‰§è¡Œç»“æœä¸­ï¼Œè‹¥æœ‰å¤šæ¡è®°å½•ï¼Œé‚£ä¹ˆ `user_id`ã€`user_name`ã€`user_email`ã€`user_password`çš„å€¼æ˜¯ä¸€æ ·çš„ã€‚è€ŒBlogä¿¡æ¯ä¼š ä¸ä¸€æ ·ã€‚ä¾‹å¦‚æ‰§è¡Œï¼š

```sql
SELECT
    user.id AS user_id,
    user.name AS user_name,
    user.email AS user_email,
    user.password AS user_password,
    blog.id AS blog_id,
    blog.title AS blog_title,
    blog.content AS blog_content
FROM user, blog 
WHERE 
    user.id = 1 
    AND user.id=blog.owner_id;
```
ç»“æœæ˜¯ï¼š

<img src="../img/0005.jpg" width="600" />

`<select id="findById"></select>`çš„resultMapå±æ€§å€¼ä¸º`userResult`ï¼Œæ‰€ä»¥ä¼šæ‰¾åˆ°`<resultMap id="userResult"></resultMap>`æ¥å¤„ç†æŸ¥è¯¢åˆ°çš„æ•°æ®ã€‚ä¸Šé¢çš„ç¤ºä¾‹ä¸­æˆ‘ä»¬æŸ¥åˆ°äº†6æ¡æ•°æ®ï¼Œmybatisæ ¹æ®`<resultMap id="userResult"></resultMap>`çš„é…ç½®ï¼Œå°†ç›¸åŒ `user_id`ã€`user_name`ã€`user_email`ã€`user_password`çš„æ•°æ®æ”¶æ‹¢åœ¨ä¸€ä¸ªUserç±»ä¸­ï¼Œè€Œ`blog_id`ã€`blog_title`ã€`blog_content`åˆ†åˆ«æ„é€ Blogå¯¹è±¡ï¼Œç„¶åæ”¾å…¥Userå¯¹è±¡çš„Listç±»å‹çš„ blogs å˜é‡ä¸­ã€‚`<collection>`ç”¨äº1å¯¹å¤šã€‚



åœ¨ Main ç±»ä¸­ç¼–å†™æµ‹è¯•ä»£ç ï¼š

```java
@Test
public void test_01() throws IOException {
    SqlSession sqlSession = getSqlSession();
    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);
    User user = userMapper.findById(1L);
    log.info("{}", user);
}
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼ˆå¿½ç•¥myabatisçš„æ‰§è¡Œä¿¡æ¯ï¼‰ï¼š

```
 INFO [main] - User(id=1, name=letian, email=letian@111.com, password=123, blogs=[Blog(id=1, ownerId=1, title=æ ‡é¢˜1, content=æ–‡æœ¬1, user=null), Blog(id=2, ownerId=1, title=æ ‡é¢˜2, content=æ–‡æœ¬2, user=null), Blog(id=3, ownerId=1, title=æ ‡é¢˜3, content=æ–‡æœ¬3, user=null), Blog(id=4, ownerId=1, title=æ ‡é¢˜4, content=æ–‡æœ¬4, user=null), Blog(id=5, ownerId=1, title=æ ‡é¢˜5, content=æ–‡æœ¬5, user=null), Blog(id=7, ownerId=1, title=ä½ å¥½, World, content=ä½ å¥½, ğŸ˜†, user=null)])
```



## æ ¹æ®å¯†ç æŸ¥è¯¢ç”¨æˆ·åŠå…¶åšå®¢ä¿¡æ¯

> å®é™…æ¡ˆä¾‹ä¸­ï¼Œå‡ ä¹ä¸ä¼šæœ‰æ ¹æ®å¯†ç æŸ¥è¯¢ç”¨æˆ·çš„ä¸šåŠ¡ã€‚è¿™é‡Œä»…ä½œä¸ºç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨mybatisã€‚



åœ¨ UserMapper æ¥å£ä¸­å¢åŠ å‡½æ•°ï¼š

```java
List<User> findByPassword(String password);
```

åœ¨ UserMapper.xml å¢åŠ æ˜ å°„ï¼š

```xml
<select id="findByPassword" parameterType="String" resultMap="userResult" resultType="bean.User">
    SELECT
        user.id AS user_id,
        user.name AS user_name,
        user.email AS user_email,
        user.password AS user_password,
        blog.id AS blog_id,
        blog.title AS blog_title,
        blog.content AS blog_content
    FROM
        user, blog
    WHERE
        user.password = #{password}
        AND user.id=blog.owner_id;
</select>
```

ä¸æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·åŠå…¶åšå®¢ä¿¡æ¯ç›¸åŒï¼Œè¿™é‡Œçš„ resultMap ä¹Ÿä½¿ç”¨äº†userResultã€‚



åœ¨ Main ç±»ä¸­å¢åŠ ç¤ºä¾‹ä»£ç ï¼š

```java
@Test
public void test_02() throws IOException {
    SqlSession sqlSession = getSqlSession();
    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);
    List<User> userList = userMapper.findByPassword("123");

    userList.forEach(user -> {
        log.info("{}", user);
    });
}
```

æ‰§è¡Œç»“æœï¼ˆå¿½ç•¥mybatisæ‰§è¡Œä¿¡æ¯ï¼‰ï¼š

```plain
 INFO [main] - User(id=1, name=letian, email=letian@111.com, password=123, blogs=[Blog(id=1, ownerId=1, title=æ ‡é¢˜1, content=æ–‡æœ¬1, user=null), Blog(id=2, ownerId=1, title=æ ‡é¢˜2, content=æ–‡æœ¬2, user=null), Blog(id=3, ownerId=1, title=æ ‡é¢˜3, content=æ–‡æœ¬3, user=null), Blog(id=4, ownerId=1, title=æ ‡é¢˜4, content=æ–‡æœ¬4, user=null), Blog(id=5, ownerId=1, title=æ ‡é¢˜5, content=æ–‡æœ¬5, user=null), Blog(id=7, ownerId=1, title=ä½ å¥½, World, content=ä½ å¥½, ğŸ˜†, user=null)])
 
 INFO [main] - User(id=2, name=xiaosi, email=xiaosi@111.com, password=123, blogs=[Blog(id=6, ownerId=2, title=æ ‡é¢˜21, content=æ–‡æœ¬21, user=null)])
```

å¾—åˆ°ä¸¤ä¸ªuserç»“æœï¼Œç¬¬1ä¸ªuseræœ‰6ä¸ªåšå®¢ï¼Œç¬¬2ä¸ªuseræœ‰1ä¸ªåšå®¢ã€‚



## æ ¹æ®idæŸ¥è¯¢åšå®¢åŠå…¶æ‰€å±ç”¨æˆ·ä¿¡æ¯

åœ¨ BlogMapper æ¥å£ä¸­æ–°å¢æ–¹æ³•ï¼š

```java
Blog findById(Long id);
```

åœ¨ BlogMapper.xml ä¸­å¢åŠ æ˜ å°„ï¼š


```xml
<resultMap id="blogResult" type="bean.Blog">
    <result property="id" column="blog_id"/>
    <result property="ownerId" column="user_id"/>
    <result property="title" column="blog_title"/>
    <result property="content" column="blog_content"/>

    <association property="user" javaType="bean.User">
        <id property="id" column="user_id"/>
        <result property="name" column="user_name"/>
        <result property="email" column="user_email"/>
        <result property="password" column="user_password"/>
    </association>

</resultMap>

<select id="findById" parameterType="Long" resultMap="blogResult" resultType="bean.Blog">
    SELECT
        blog.id AS blog_id,
        blog.title AS blog_title,
        blog.content AS blog_content,
        user.id AS user_id,
        user.name AS user_name,
        user.email AS user_email,
        user.password AS user_password
    FROM blog, user 
    WHERE 
        blog.id = #{id} 
        AND user.id=blog.owner_id;
</select>
```

è¿™æ®µxmlä¸­çš„é€»è¾‘å’Œä¸Šé¢è·å–ç”¨æˆ·ä»¥åŠåšå®¢ä¿¡æ¯çš„æ€è·¯æ˜¯ä¸€æ ·çš„ã€‚å› ä¸ºåšå®¢å’Œç”¨æˆ·æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œæ‰€ä»¥`<resultMap>` ä¸­ç”¨çš„æ˜¯`<association>`ï¼Œè€Œé`<collection>`ã€‚



åœ¨ Main ç±»ä¸­ç¼–å†™ç¤ºä¾‹ä»£ç ï¼š

```java
@Test
public void test_03() throws IOException {
    SqlSession sqlSession = getSqlSession();
    BlogMapper blogMapper = sqlSession.getMapper(BlogMapper.class);
    Blog blog = blogMapper.findById(1L);
    log.info("{}", blog);
}
```

æ‰§è¡Œç»“æœï¼ˆå¿½ç•¥mybatisæ‰§è¡Œä¿¡æ¯ï¼‰ï¼š

```plain
 INFO [main] - Blog(id=1, ownerId=1, title=æ ‡é¢˜1, content=æ–‡æœ¬1, user=User(id=1, name=letian, email=letian@111.com, password=123, blogs=null))
```

ç¬¦åˆé¢„æœŸ ğŸ˜Š

